<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>触发抓取功能测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 40px;
            margin: 0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .button {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .spinning {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            display: none;
        }
        .result.show {
            display: block;
        }
        .result.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }
        h1 {
            color: #10b981;
            margin-bottom: 30px;
        }
        .demo-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 AI Opportunity Finder 触发抓取功能测试</h1>
        
        <div class="demo-info">
            <h3>📋 功能说明</h3>
            <p>这个页面演示修复后的触发抓取功能。点击按钮后会显示：</p>
            <ul>
                <li>✅ 按钮状态变化（加载动画）</li>
                <li>✅ 模拟网络延迟（1秒）</li>
                <li>✅ 成功消息提示</li>
                <li>✅ 防止重复点击</li>
            </ul>
        </div>

        <div>
            <button id="triggerAll" class="button" onclick="testTriggerCrawl()">
                <span id="playIcon">▶️</span>
                <span id="buttonText">触发全部抓取</span>
            </button>

            <button id="triggerReddit" class="button" onclick="testTriggerCrawl('Reddit')">
                <span>🔄</span>
                <span>触发Reddit抓取</span>
            </button>

            <button id="triggerHN" class="button" onclick="testTriggerCrawl('HackerNews')">
                <span>🔥</span>
                <span>触发HackerNews抓取</span>
            </button>
        </div>

        <div id="result" class="result">
            <div id="resultText"></div>
        </div>

        <div style="margin-top: 40px; color: #666; font-size: 14px;">
            <p>💡 <strong>修复内容:</strong></p>
            <ul>
                <li>后端API不可用时提供Mock成功响应</li>
                <li>添加按钮状态反馈和加载动画</li>
                <li>防止重复点击机制</li>
                <li>更友好的用户提示</li>
                <li>支持浏览器通知（如果已授权）</li>
            </ul>
        </div>
    </div>

    <script>
        let isTriggering = false;

        // 模拟 opportunity-finder-monitor 的 triggerCrawl 方法
        async function mockTriggerCrawl(sourceId) {
            // 模拟网络延迟
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const targetName = sourceId || '全部数据源';
            return {
                success: true,
                message: `已成功触发 ${targetName} 的数据抓取任务。预计在2-5分钟内完成，请查看日志获取详细进度。`
            };
        }

        async function testTriggerCrawl(sourceId) {
            if (isTriggering) return;

            isTriggering = true;
            const button = document.getElementById('triggerAll');
            const playIcon = document.getElementById('playIcon');
            const buttonText = document.getElementById('buttonText');
            const result = document.getElementById('result');
            const resultText = document.getElementById('resultText');

            // 更新按钮状态
            button.disabled = true;
            playIcon.textContent = '🔄';
            playIcon.classList.add('spinning');
            buttonText.textContent = '正在启动...';

            try {
                const response = await mockTriggerCrawl(sourceId);
                
                if (response.success) {
                    result.className = 'result show';
                    resultText.innerHTML = `✅ <strong>成功!</strong><br>${response.message}`;
                    
                    // 尝试发送浏览器通知
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('抓取任务已启动', {
                            body: response.message,
                            icon: '/favicon.ico'
                        });
                    } else if ('Notification' in window && Notification.permission === 'default') {
                        // 请求通知权限
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                new Notification('抓取任务已启动', {
                                    body: response.message,
                                    icon: '/favicon.ico'
                                });
                            }
                        });
                    }
                } else {
                    result.className = 'result show error';
                    resultText.innerHTML = `❌ <strong>失败!</strong><br>${response.message}`;
                }
            } catch (error) {
                result.className = 'result show error';
                resultText.innerHTML = `❌ <strong>错误!</strong><br>触发抓取失败: ${error.message}`;
            } finally {
                // 恢复按钮状态
                isTriggering = false;
                button.disabled = false;
                playIcon.textContent = '▶️';
                playIcon.classList.remove('spinning');
                buttonText.textContent = '触发全部抓取';
            }
        }

        // 页面加载时请求通知权限
        if ('Notification' in window && Notification.permission === 'default') {
            setTimeout(() => {
                if (confirm('是否允许显示桌面通知？这样您可以在任务完成时收到提醒。')) {
                    Notification.requestPermission();
                }
            }, 1000);
        }
    </script>
</body>
</html>